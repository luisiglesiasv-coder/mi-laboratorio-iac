name: BDD Test Workflow

on: [push]

jobs:
  bdd_tests:
    # AsegÃºrate de que tu runner self-hosted tiene la etiqueta correcta
    runs-on: self-hosted 
    
    steps:
    
      - name: Checkout del CÃ³digo
        uses: actions/checkout@v4

      # 1. Instalar Vault CLI (Igual que antes)
      - name: Instalar Vault CLI (SoluciÃ³n sin Sudo)
        shell: bash
        run: |
          VAULT_VERSION="1.16.0"
          # IMPORTANTE: AsegÃºrate de que la arquitectura (linux_amd64) es correcta para tu runner
          URL="https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip"
          
          curl -LO "$URL"
          unzip vault_${VAULT_VERSION}_linux_amd64.zip
          
          mkdir -p "$HOME/bin"
          mv vault "$HOME/bin/"
          
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "âœ… Cliente Vault (v$VAULT_VERSION) instalado localmente."
      
      # ----------------------------------------------------
      # ðŸ”‘ NUEVO: AutenticaciÃ³n con AppRole
      # ----------------------------------------------------
      - name: Autenticar con Vault (AppRole Login)
        id: vault_login
        shell: bash
        env:
          VAULT_ADDR: http://10.0.0.31:8200
          # Inyectamos los secretos que acabas de crear en GitHub
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          # Usamos el comando 'vault write' para hacer login en el endpoint de AppRole
          # y guardamos la respuesta JSON
          LOGIN_RESPONSE=$(vault write -format=json auth/approle/login \
            role_id="$VAULT_ROLE_ID" \
            secret_id="$VAULT_SECRET_ID")

          # Extraemos el token temporal del cliente desde la respuesta JSON
          VAULT_CLIENT_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.auth.client_token')
          
          # Validamos que hemos obtenido un token
          if [ -z "$VAULT_CLIENT_TOKEN" ] || [ "$VAULT_CLIENT_TOKEN" == "null" ]; then
            echo "âŒ Error: No se pudo obtener el token de cliente mediante AppRole."
            exit 1
          fi

          # Exportamos el token como una variable de entorno SECRETA para los siguientes pasos.
          # Esto es fundamental: '::add-mask::' evita que el token se imprima en los logs.
          echo "::add-mask::$VAULT_CLIENT_TOKEN"
          echo "VAULT_TOKEN=$VAULT_CLIENT_TOKEN" >> $GITHUB_ENV
          
          echo "âœ… AutenticaciÃ³n AppRole exitosa. Token temporal obtenido."

      # ----------------------------------------------------
      # ðŸ”‘ NUEVO: Obtener Credenciales DinÃ¡micas (Usando el Token Temporal)
      # ----------------------------------------------------
      - name: Obtener Credenciales DinÃ¡micas de Base de Datos
        id: db_creds
        shell: bash
        env:
          VAULT_ADDR: http://10.0.0.31:8200
          # No necesitamos definir VAULT_TOKEN aquÃ­ explÃ­citamente,
          # ya que lo exportamos al $GITHUB_ENV en el paso anterior.
        run: |
          # Leemos el secreto dinÃ¡mico. Vault CLI usarÃ¡ automÃ¡ticamente la variable
          # de entorno VAULT_TOKEN que configuramos en el paso anterior.
          SECRET_DATA=$(vault read -format=json database/creds/runner_role)
          
          # Parseamos el JSON para obtener usuario y contraseÃ±a
          DB_USER=$(echo "$SECRET_DATA" | jq -r '.data.username')
          DB_PASS=$(echo "$SECRET_DATA" | jq -r '.data.password')
          
          # Validamos que tenemos las credenciales
          if [ -z "$DB_USER" ] || [ "$DB_USER" == "null" ]; then
            echo "âŒ Error: No se pudieron obtener las credenciales de la base de datos."
            exit 1
          fi

          # Exportamos las credenciales para que las usen las pruebas de Python.
          # Usamos '::add-mask::' para la contraseÃ±a por seguridad.
          echo "DB_USER=$DB_USER" >> $GITHUB_ENV
          echo "::add-mask::$DB_PASS"
          echo "DB_PASS=$DB_PASS" >> $GITHUB_ENV
          
          echo "âœ… Credenciales dinÃ¡micas (Usuario: $DB_USER) obtenidas y exportadas."

      - name: Instalar Dependencias de Python
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
      # ----------------------------------------------------
      # ðŸš€ EJECUTAR PRUEBAS
      # ----------------------------------------------------
      - name: Ejecutar Pruebas BDD Behave
        shell: bash
        run: |
          source venv/bin/activate
          # Definimos el host de la base de datos
          export DB_HOST=10.0.0.31
          # Las variables DB_USER y DB_PASS ya estÃ¡n en el entorno gracias al paso anterior
          behave tests/features/