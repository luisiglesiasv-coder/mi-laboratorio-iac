name: BDD Test Workflow

on: [push]

jobs:
  bdd_tests:
    runs-on: self-hosted # O la etiqueta de tu Runner (ej. web-node)
    
    steps:
    
      - name: Checkout del CÃ³digo
        uses: actions/checkout@v4

      # ðŸ”‘ PASO CRÃTICO: Descargar, Descomprimir y AÃ±adir al PATH Local
      - name: Instalar Vault CLI (SoluciÃ³n sin Sudo)
        shell: bash
        run: |
          # 1. Definir la versiÃ³n y la arquitectura
          VAULT_VERSION="1.16.0"
          
          # Suponiendo que el runner es Linux. Si es macOS, cambia a darwin_amd64.
          URL="https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip"
          
          # 2. Descargar en el directorio de trabajo actual
          curl -LO "$URL"
          unzip vault_${VAULT_VERSION}_linux_amd64.zip
          
          # 3. Mover el ejecutable a una carpeta en el entorno local (p.ej., $HOME/bin)
          # Esto garantiza que el runner tiene permisos
          mkdir -p "$HOME/bin"
          mv vault "$HOME/bin/"
          
          # 4. Exportar el nuevo binario a la variable de entorno $PATH para el resto del job
          echo "$HOME/bin" >> $GITHUB_PATH
          
          echo "âœ… Cliente Vault (v$VAULT_VERSION) instalado localmente y aÃ±adido al PATH."
      
          # ----------------------------------------------------
      # ðŸ”‘ PASOS CRÃTICOS: Obtener Credenciales de Vault
      # ----------------------------------------------------
      - name: Configurar Variables de Vault y Obtener Credenciales DinÃ¡micas
        id: vault_creds
        shell: bash
        env:
          VAULT_ADDR: http://10.0.0.31:8200
          # Usaremos el token root fijo para IaC. En producciÃ³n, usa VAULT_TOKEN de AppRole.
          VAULT_TOKEN: ${{ secrets.VAULT_ROOT_TOKEN }}
        run: |
          echo "VAULT_ADDR=$VAULT_ADDR"

          # 1. Leer el secreto dinÃ¡mico de la DB
          SECRET_DATA=$(vault read -format=json database/creds/runner_role)
          
          # 2. Parsear el JSON y exportar las variables
          DB_USER=$(echo "$SECRET_DATA" | jq -r '.data.username')
          DB_PASS=$(echo "$SECRET_DATA" | jq -r '.data.password')
          
          # 3. Exportar variables a GitHub Actions Runner
          # Esto hace que DB_USER y DB_PASS estÃ©n disponibles para pasos posteriores
          echo "DB_USER=$DB_USER" >> $GITHUB_ENV
          echo "DB_PASS=$DB_PASS" >> $GITHUB_ENV
          
          echo "âœ… Credenciales dinÃ¡micas obtenidas."

      - name: Instalar Dependencias de Python
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
      # ----------------------------------------------------
      # ðŸš€ EJECUTAR PRUEBAS
      # ----------------------------------------------------
      - name: Ejecutar Pruebas BDD Behave
        shell: bash
        # Las variables DB_USER y DB_PASS ahora estÃ¡n disponibles automÃ¡ticamente
        run: |
          source venv/bin/activate
          # El cÃ³digo Python de la prueba debe leer las variables de entorno:
          # os.environ.get('DB_USER'), os.environ.get('DB_PASS'), os.environ.get('DB_HOST')
          export DB_HOST=10.0.0.31
          behave tests/features/

