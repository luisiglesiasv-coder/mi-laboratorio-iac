# .github/workflows/ci_tests.yml

name: Ejecutar Pruebas de Infraestructura (CI)

on:
  push:
    branches: [ main ] 

jobs:
  bdd_tests: 
    runs-on: self-hosted 
    
    # Definimos las variables de entorno de Vault y los secretos de AppRole
    env:
      VAULT_ADDR: http://10.0.0.31:8200
      VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
      VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
      REDIS_ROLE_NAME: redis-runner-role
      
    steps:
    - name: Checkout del Código
      uses: actions/checkout@v4 

    # --- TAREA 1: CONFIGURAR ENTORNO ---
    - name: 1.1 Instalar Vault CLI y JQ
      run: |
        VAULT_VERSION="1.16.0"
        URL="https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip"
        curl -LO "$URL"
        unzip -o vault_${VAULT_VERSION}_linux_amd64.zip
        mkdir -p "$HOME/bin"
        mv vault "$HOME/bin/"
        curl -Lo "$HOME/bin/jq" https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
        chmod +x "$HOME/bin/jq"
        echo "$HOME/bin" >> $GITHUB_PATH
        echo "✅ Herramientas instaladas."

    # --- TAREA 2: OBTENCIÓN DE SECRETOS ---
    - name: 2.1 Autenticar con Vault (AppRole)
      id: vault_login
      run: |
        LOGIN_RESPONSE=$(vault write -format=json auth/approle/login role_id="$VAULT_ROLE_ID" secret_id="$VAULT_SECRET_ID")
        VAULT_CLIENT_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.auth.client_token')
        if [ -z "$VAULT_CLIENT_TOKEN" ] || [ "$VAULT_CLIENT_TOKEN" == "null" ]; then exit 1; fi
        echo "::add-mask::$VAULT_CLIENT_TOKEN"
        echo "VAULT_TOKEN=$VAULT_CLIENT_TOKEN" >> $GITHUB_ENV
        echo "✅ Autenticación exitosa."

    - name: 2.2 Obtener Credenciales Dinámicas (PG y Redis)
      id: creds
      run: |
        # --- PostgreSQL ---
        PG_DATA=$(vault read -token="$VAULT_TOKEN" -format=json database/creds/runner-role)
        DB_USER=$(echo "$PG_DATA" | jq -r '.data.username')
        DB_PASS=$(echo "$PG_DATA" | jq -r '.data.password')
        PG_LEASE=$(echo "$PG_DATA" | jq -r '.lease_id') 

        # --- Redis ---
        REDIS_DATA=$(vault read -token="$VAULT_TOKEN" -format=json database/creds/$REDIS_ROLE_NAME)
        REDIS_USER=$(echo "$REDIS_DATA" | jq -r '.data.username')
        REDIS_PASS=$(echo "$REDIS_DATA" | jq -r '.data.password')
        REDIS_LEASE=$(echo "$REDIS_DATA" | jq -r '.lease_id')

        # --- Validaciones ---
        if [ -z "$DB_USER" ] || [ "$REDIS_USER" == "null" ]; then echo "❌ Error obteniendo credenciales"; exit 1; fi

        # --- Exportar ---
        echo "DB_USER=$DB_USER" >> $GITHUB_ENV
        echo "::add-mask::$DB_PASS"
        echo "DB_PASS=$DB_PASS" >> $GITHUB_ENV
        echo "REDIS_USER=$REDIS_USER" >> $GITHUB_ENV
        echo "::add-mask::$REDIS_PASS"
        echo "REDIS_PASS=$REDIS_PASS" >> $GITHUB_ENV
        
        # Exportar Leases para limpieza
        echo "pg_lease_id=$PG_LEASE" >> $GITHUB_OUTPUT 
        echo "redis_lease_id=$REDIS_LEASE" >> $GITHUB_OUTPUT
        echo "✅ Credenciales obtenidas correctamente."

    # --- TAREA 3: EJECUCIÓN DE PRUEBAS ---
    - name: 3.1 Instalar Dependencias
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
        
    - name: 3.2 Ejecutar Pruebas BDD
      run: ./venv/bin/behave -i tests/features
      env:
        DB_HOST: 10.0.0.31
        REDIS_HOST: 10.0.0.31
        WEB_HOST: 10.0.0.23
        # Inyección de secretos explícita
        DB_USER: ${{ env.DB_USER }}
        DB_PASS: ${{ env.DB_PASS }}
        REDIS_USER: ${{ env.REDIS_USER }}
        REDIS_PASS: ${{ env.REDIS_PASS }}

    # --- TAREA 4: LIMPIEZA ---
    - name: 4.1 Revocar Credenciales
      if: always()
      run: |
        vault lease revoke "${{ steps.creds.outputs.pg_lease_id }}" 2>/dev/null || true
        vault lease revoke "${{ steps.creds.outputs.redis_lease_id }}" 2>/dev/null || true
        vault token revoke -self 2>/dev/null || true
        echo "✅ Limpieza completada."