---
- name: FASE 2 | Configuraci√≥n del Servidor de Base de Datos (PostgreSQL)
  hosts: db-node
  become: true
  vars:
    vault_token: "hvs.TlA2xCHPWSebAjrI9NTnxI3G"
    pg_version: "17" # üö® AGREGAR: Define la versi√≥n para rutas din√°micas
    pg_vault_password: "PostgreSQL*123" # üö® AGREGAR: Contrase√±a que Vault usar√°
    
  tasks:
    
    # 1. Leer el secreto de Vault
    - name: 1. Leer contrase√±a de Vault
      ansible.builtin.uri:
        url: http://10.0.0.31:8200/v1/kv/production/db
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
      register: db_secret

    
    - name: (CLEANUP) Eliminar directorio temporal conflictivo para postgres
      ansible.builtin.file:
        path: /var/lib/postgresql/.ansible
        state: absent
      become: true

    - name: 2. Instalar PostgreSQL y librer√≠a para Python
      ansible.builtin.apt:
        name: 
          - postgresql
          - python3-psycopg2
        state: present
        update_cache: yes
    
    - name: 3. Asegurar que PostgreSQL est√© corriendo
      ansible.builtin.service:
        name: postgresql
        state: started
        enabled: yes
    
    # --- TAREAS DE ACCESIBILIDAD ---

    - name: 3.1. Configurar 'postgresql.conf' para escuchar en todas las IPs ('*')
      ansible.builtin.lineinfile:
        path: /etc/postgresql/{{ pg_version }}/main/postgresql.conf # ‚úÖ CORREGIDO
        regexp: '^#?listen_addresses'
        line: "listen_addresses = '*'"
        state: present
      notify: Reiniciar PostgreSQL

    - name: 3.2. Configurar 'pg_hba.conf' - Forzar autenticaci√≥n MD5 para Loopback (127.0.0.1)
      ansible.builtin.lineinfile:
        path: /etc/postgresql/{{ pg_version }}/main/pg_hba.conf # ‚úÖ CORREGIDO
        regexp: '^\s*host\s+all\s+all\s+127\.0\.0\.1/32\s+(scram-sha-256|md5|peer|ident)'
        line: "host\t all\t all\t 127.0.0.1/32\t\t md5"
        state: present
      notify: Reiniciar PostgreSQL

    - name: 3.3. Configurar 'pg_hba.conf'- Permitir autenticaci√≥n MD5 para red 10.0.0.0/24
      ansible.builtin.lineinfile:
        path: /etc/postgresql/{{ pg_version }}/main/pg_hba.conf # ‚úÖ CORREGIDO
        line: "host\t all\t all\t 10.0.0.0/24\t\t md5"
        state: present
        insertafter: EOF
      notify: Reiniciar PostgreSQL

    # ----------------------------------------------------
    # üö® TAREA CR√çTICA A√ëADIDA üö®
    # ----------------------------------------------------
    - name: 4. Asignar Contrase√±a al Superusuario 'postgres' (Para Conexi√≥n de Vault)
      ansible.builtin.postgresql_user:
        login_user: postgres
        name: postgres
        password: "{{ pg_vault_password }}" # Usamos la nueva contrase√±a fuerte
        state: present
      become_user: postgres
    # ----------------------------------------------------

    - name: '5. Crear usuario de base de datos (Ejemplo: app_user)' # Antes Tarea 4
      ansible.builtin.postgresql_user:
        login_user: postgres
        name: app_user
        password: "{{ db_secret.json.data.password }}" 
        state: present
      become_user: postgres
      
    - name: '6. Crear la base de datos de la aplicaci√≥n (Ejemplo: app_db)' # Antes Tarea 5
      ansible.builtin.postgresql_db:
        login_user: postgres
        name: app_db
        owner: app_user
        encoding: UTF-8
        state: present
      become_user: postgres

  handlers:
    - name: Reiniciar PostgreSQL
      ansible.builtin.service:
        name: postgresql
        state: restarted