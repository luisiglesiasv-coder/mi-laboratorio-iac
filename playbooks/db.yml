---
- name: Phase 2 - Database Infrastructure and Application Setup
  hosts: db-node
  become: true
  vars:
    vault_token: "hvs.TlA2xCHPWSebAjrI9NTnxI3G" # Placeholder for dynamic credentials
    pg_version: "17"
    pg_vault_password: "PostgreSQL*123" 
    
  roles:
    - postgres_server # Standardized role call

  tasks:
    - name: Vault Integration - Fetch application secrets from KV store
      ansible.builtin.uri:
        url: http://10.0.0.31:8200/v1/kv/production/db
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
      register: db_secret

    - name: Application Setup - Create application database user (app_user)
      ansible.builtin.postgresql_user:
        login_user: postgres
        name: app_user
        password: "{{ db_secret.json.data.password }}" 
        state: present
      become_user: postgres
      
    - name: Application Setup - Create application database (app_db)
      ansible.builtin.postgresql_db:
        login_user: postgres
        name: app_db
        owner: app_user
        encoding: UTF-8
        state: present
      become_user: postgres