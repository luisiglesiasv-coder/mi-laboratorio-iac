---
# roles/vault_server/molecule/default/verify.yml
# Unit Tests: Infrastructure and Service Validation (Single Node)

- name: Verify Vault Server Infrastructure
  hosts: all  # In the default scenario, this is just your single vault container
  gather_facts: true
  
  tasks:
    # --- 0. PREPARATION ---
    - name: 0.1 Load role defaults
      # We explicitly load the role defaults so verify knows the ports and paths
      # Path is relative to the molecule/default/ directory
      ansible.builtin.include_vars:
        file: ../../defaults/main.yml

    - name: 0.2 Load scenario variables (if any)
      ansible.builtin.include_vars:
        file: group_vars/all.yml
      ignore_errors: true # It's okay if this file is empty now

    # --- 1. SERVICE VALIDATION ---
    - name: 1.1 Populate service facts
      ansible.builtin.service_facts:

    - name: 1.2 Assert Vault service is running and enabled
      ansible.builtin.assert:
        that:
          - ansible_facts.services['vault.service'].state == 'running'
          - ansible_facts.services['vault.service'].status == 'enabled'
        fail_msg: "Vault service is NOT healthy or NOT enabled at OS level"

    # --- 2. BINARY VALIDATION ---
    - name: 2.1 Check Vault binary version
      ansible.builtin.command: vault version
      register: vault_version_output
      changed_when: false

    - name: 2.2 Assert Vault version is correct
      ansible.builtin.assert:
        that:
          - "'1.15.4' in vault_version_output.stdout"
        fail_msg: "The installed Vault version does not match the expected 1.15.4"

    # --- 3. API & SEAL STATUS VALIDATION ---
    - name: 3.1 Query Vault health via API
      # Using the URI module to verify Vault is actually listening
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/sys/health"
        method: GET
        # 200: Unsealed, 503: Sealed, 501: Uninitialized
        status_code: [200, 503, 501]
      register: vault_health

    - name: 3.2 Assert Vault is initialized and unsealed
      # This confirms that our 'converge' did its job correctly
      ansible.builtin.assert:
        that:
          - vault_health.json.initialized == true
          - vault_health.json.sealed == false
        fail_msg: "Vault is sealed or uninitialized. API Status: {{ vault_health.status }}"

    # --- 4. CONFIGURATION VALIDATION ---
    - name: 4.1 Check if Vault configuration file exists
      ansible.builtin.stat:
        path: /etc/vault.d/vault.hcl
      register: hcl_file

    - name: 4.2 Assert HCL config file is present and not empty
      ansible.builtin.assert:
        that:
          - hcl_file.stat.exists
          - hcl_file.stat.size > 0
        fail_msg: "Vault configuration file is missing or empty"