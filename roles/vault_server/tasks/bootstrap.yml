---
# tasks/bootstrap.yml - Initialization and Unsealing logic

- name: "[BOOTSTRAP] 1.1 Check if Vault is already initialized"
  ansible.builtin.uri:
    url: "{{ vault_addr }}/v1/sys/init"
    method: GET
  register: vault_init_check

- name: "[BOOTSTRAP] 1.2 Initialize Vault if new"
  ansible.builtin.uri:
    url: "{{ vault_addr }}/v1/sys/init"
    method: PUT
    body_format: json
    # We send the JSON as a string literal so numbers don't get quoted
    body: '{"secret_shares": {{ vault_init_shares | int }}, "secret_threshold": {{ vault_init_threshold | int }}}'
  register: vault_init_results
  changed_when: vault_init_results.status == 200
  when: not (vault_init_check.json.initialized | default(false))

- name: "[BOOTSTRAP] 1.3 Ensure local keys directory exists"
  ansible.builtin.file:
    path: "{{ vault_unseal_keys_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost
  run_once: true
  become: false

- name: "[BOOTSTRAP] 1.4 Save Vault credentials to local JSON"
  ansible.builtin.copy:
    content: "{{ vault_init_results.json | to_nice_json }}"
    dest: "{{ vault_local_init_file }}"
    mode: '0644'
  delegate_to: localhost
  when: vault_init_results.changed | default(false)
  become: false

# We always attempt to load the keys from the file to handle unsealing 
# even if initialization happened in a previous run.
- name: "[BOOTSTRAP] 1.5 Load credentials for unsealing"
  ansible.builtin.set_fact:
    vault_creds: "{{ lookup('file', vault_local_init_file) | from_json }}"
  ignore_errors: yes

- name: "[BOOTSTRAP] 1.6 Unseal Vault using stored keys"
  ansible.builtin.uri:
    url: "{{ vault_addr }}/v1/sys/unseal"
    method: PUT
    body_format: json
    body:
      key: "{{ item }}"
  loop: "{{ vault_creds['keys'] | default([]) }}"
  when: 
    - vault_creds is defined
    - (vault_init_results.changed | default(false)) or vault_init_check.json.initialized