# playbooks/vault_server/tasks/configure_postgres.yml
---
- name: "Postgres | Configurar la conexi√≥n administrativa"
  community.hashi_vault.vault_write:
    url: "{{ vault_addr }}"
    token: "{{ vault_token }}"
    path: database/config/postgresql
    data:
      plugin_name: postgresql-database-plugin
      allowed_roles: runner_role
      connection_url: "postgresql://{{username}}:{{password}}@10.0.0.31:5432/?sslmode=disable"
      username: postgres
      password: "{{ pg_vault_password }}"
  vars:
    username: "{{ '{{username}}' }}"
    password: "{{ '{{password}}' }}"

- name: "Postgres | Crear el Rol 'runner_role' para credenciales temporales"
  community.hashi_vault.vault_write:
    url: "{{ vault_addr }}"
    token: "{{ vault_token }}"
    path: database/roles/runner_role
    data:
      db_name: postgresql
      creation_statements: |
        CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
        GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO "{{name}}";
      default_ttl: "1h"
      max_ttl: "24h"
  vars:
    name: "{{ '{{name}}' }}"
    password: "{{ '{{password}}' }}"
    expiration: "{{ '{{expiration}}' }}"