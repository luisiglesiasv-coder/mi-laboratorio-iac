---
# tasks/provisioning/roles/ci-runner.yml

- name: ROLE | Check if AppRole for CI-Runner exists (Idempotency Check)
  community.hashi_vault.vault_read:
    url: "{{ vault_addr }}"
    token: "{{ vault_root_token_mem }}"
    path: "auth/approle/role/ci-runner"
  register: current_role_raw
  # --- LOGGING LIMPIO ---
  failed_when: false
  changed_when: false

- name: ROLE | Create/Update AppRole for CI-Runner
  community.hashi_vault.vault_write:
    url: "{{ vault_addr }}"
    token: "{{ vault_root_token_mem }}"
    path: "auth/approle/role/ci-runner"
    data:
      token_policies: "ci-runner-policy"
      token_ttl: "1h"
      token_max_ttl: "4h"
  when: current_role_raw.failed
  register: role_creation_result

- name: ROLE | Get Role ID for ci-runner
  community.hashi_vault.vault_read:
    url: "{{ vault_addr }}"
    token: "{{ vault_root_token_mem }}"
    path: "auth/approle/role/ci-runner/role-id"
  register: ci_runner_role_id

- name: LOCAL | Save Role ID to Mac
  ansible.builtin.copy:
    content: "{{ ci_runner_role_id.data.data.role_id }}"
    dest: "{{ role_path }}/files/ci_runner_role_id.txt"
    mode: '0600'
  delegate_to: localhost
  become: false

- name: LOCAL | Check if Secret ID file exists on Mac
  ansible.builtin.stat:
    path: "{{ role_path }}/files/ci_runner_secret_id.txt"
  register: secret_id_file
  delegate_to: localhost
  become: false

- name: ROLE | Generate new Secret ID ONLY if missing
  community.hashi_vault.vault_write:
    url: "{{ vault_addr }}"
    token: "{{ vault_root_token_mem }}"
    path: "auth/approle/role/ci-runner/secret-id"
  register: new_secret_id
  when: not (secret_id_file.stat.exists | default(false))

- name: LOCAL | Save Secret ID ONLY if it was newly generated
  ansible.builtin.copy:
    content: "{{ new_secret_id.data.data.secret_id | default('') }}"
    dest: "{{ role_path }}/files/ci_runner_secret_id.txt"
    mode: '0600'
  delegate_to: localhost
  become: false
  when: 
    - new_secret_id is defined
    - new_secret_id.changed